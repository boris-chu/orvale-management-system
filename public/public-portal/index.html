<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Support Portal - Orvale Management System</title>
    <meta name="author" content="Boris Chu">
    <meta name="description" content="Submit IT support requests through the Orvale Management System">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="./support.ico">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        'primary-hover': '#2563eb',
                        border: '#e5e7eb',
                        background: '#ffffff',
                        foreground: '#111827',
                        muted: '#6b7280',
                        'muted-foreground': '#9ca3af',
                        card: '#ffffff',
                        'card-foreground': '#111827',
                    }
                }
            }
        }
    </script>
    <style>
        /* Modern animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.9) translateY(-50px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        
        /* Custom styles for notification modals */
        .login-overlay {
            animation: fadeIn 0.3s ease-out;
        }
        .login-modal {
            animation: modalSlideIn 0.3s ease-out;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 font-sans text-foreground">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <div class="flex items-center justify-center">
                <div class="flex items-center space-x-3">
                    <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                    </svg>
                    <h1 class="text-2xl font-bold text-gray-900">IT Support Portal</h1>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <p class="text-lg text-gray-600">
                Submit your IT support request through the <strong class="text-blue-600">Orvale Management System</strong><br>
                Our IT team will assist you as soon as possible.
            </p>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-lg shadow-sm border p-8 mb-8">
            <form id="emailGeneratorForm" class="space-y-6">
                <!-- Support Team Selection -->
                <div>
                    <label for="emailRecipient" class="block text-sm font-medium text-gray-700 mb-2">Select Support Team:</label>
                    <select id="emailRecipient" name="emailRecipient" required class="w-full max-w-md px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Choose Your Location</option>
                        <option value="BechtelTechs@dpss.lacounty.gov">DPSS Academy</option>
                        <option value="BHRTechs@dpss.lacounty.gov">Bureau of Human Resources</option>
                        <option value="CrossroadsITSupport@dpss.lacounty.gov">Crossroads East</option>
                        <option value="CrossroadsITSupport@dpss.lacounty.gov">Crossroads Main</option>
                        <option value="CrossroadsITSupport@dpss.lacounty.gov">Crossroads West</option>
                        <option value="FODTechs@dpss.lacounty.gov">Kaiser Building (FOD | IHSS | LOD)</option>
                    </select>
                </div>

                <!-- On Behalf Radio Group -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Is this request on behalf of another person?</label>
                    <div class="flex gap-6">
                        <label class="flex items-center">
                            <input type="radio" name="onBehalf" value="No" required checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">No, this is for me</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="onBehalf" value="Yes" required class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">Yes, for someone else</span>
                        </label>
                    </div>
                </div>

                <!-- Employee Information -->
                <div id="employeeInfoGroup">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="employeeNumber" class="block text-sm font-medium text-gray-700 mb-2">Employee Number:</label>
                            <input type="text" id="employeeNumber" name="employeeNumber" 
                                   placeholder="e123456" maxlength="7" pattern="[ect][0-9]{6}" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="employeeName" class="block text-sm font-medium text-gray-700 mb-2">Name:</label>
                            <input type="text" id="employeeName" name="employeeName" 
                                   placeholder="Enter your full name" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Other Employee Information (Hidden by default) -->
                <div id="otherEmployeeGroup" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="otherEmployeeNumber" class="block text-sm font-medium text-gray-700 mb-2">Other Employee Number:</label>
                            <input type="text" id="otherEmployeeNumber" name="otherEmployeeNumber" 
                                   placeholder="e123456" maxlength="7" pattern="[ect][0-9]{6}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="otherEmployeeName" class="block text-sm font-medium text-gray-700 mb-2">Other Employee's Name:</label>
                            <input type="text" id="otherEmployeeName" name="otherEmployeeName" 
                                   placeholder="Enter the other employee's full name"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Teleworking Radio Group -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Are you teleworking today?</label>
                    <div class="flex gap-6">
                        <label class="flex items-center">
                            <input type="radio" name="teleworking" value="Yes" required class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">Yes</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="teleworking" value="No" required class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">No</span>
                        </label>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-2">Phone:</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" 
                               placeholder="(XXX) XXX-XXXX" pattern="\(\d{3}\) \d{3}-\d{4}" maxlength="14" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700 mb-2">Cubicle / Room #:</label>
                        <input type="text" id="location" name="location" 
                               placeholder="e.g., Cubicle 4B-123 or Room 205" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Section -->
                <div>
                    <label for="section" class="block text-sm font-medium text-gray-700 mb-2">Section:</label>
                    <select id="section" name="section" required class="w-full max-w-md px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Section</option>
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>

                <!-- Issue Details -->
                <div>
                    <label for="issueTitle" class="block text-sm font-medium text-gray-700 mb-2">Subject:</label>
                    <input type="text" id="issueTitle" name="issueTitle" 
                           placeholder="Tech Support Request" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="issueDescription" class="block text-sm font-medium text-gray-700 mb-2">Issue Description:</label>
                    <textarea id="issueDescription" name="issueDescription" rows="4"
                              placeholder="Briefly explain the technical issue you're facing" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-vertical"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Generate Email
                    </button>
                    <button type="button" onclick="resetForm()" class="inline-flex items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Reset to Default
                    </button>
                </div>
                
                <!-- Storage Information -->
                <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-500">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <small class="text-xs text-gray-600">
                            Your information (Support Team, Name, Employee Number, Phone, Location, Section) will be saved and pre-filled for 30 days.
                        </small>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="autoRenewStorage" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="autoRenewStorage" class="text-xs text-gray-600 cursor-pointer">
                                Auto-renew on visit
                            </label>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Computer Information Card -->
        <div class="bg-white rounded-lg shadow-sm border p-6 relative">
            <h3 class="text-lg font-semibold text-blue-600 mb-4">Your Computer Information</h3>
            <div id="computerInfoDisplay" class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-700 min-w-[140px]">IP Address:</span>
                    <span id="ipAddress" class="text-sm font-mono text-gray-900">Detecting...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-700 min-w-[140px]">Domain:</span>
                    <span id="domain" class="text-sm font-mono text-gray-900">LADPSS</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-700 min-w-[140px]">Browser:</span>
                    <span id="browserInfo" class="text-sm font-mono text-gray-900">Detecting...</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-700 min-w-[140px]">Timestamp:</span>
                    <span id="timestamp" class="text-sm font-mono text-gray-900">-</span>
                </div>
            </div>
            <!-- Hidden access to ticket management system -->
            <div class="absolute bottom-0 right-0 w-20 h-20 opacity-0 cursor-pointer z-10" onclick="showLoginModal()" title="Access Ticket Management System"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <div class="text-center text-sm text-gray-600">
                <p>&copy; 2025 Orvale Management System. All rights reserved.</p>
                <p class="mt-1">Created by Boris Chu - ITSD Region 7</p>
            </div>
        </div>
    </footer>    <script type="module">
        // Import organizational data
        import { organizationalData } from './organizational-data.js';
        
        // Computer Information Detection
        const computerInfo = {
            userAccount: 'Unknown',
            ipAddress: 'Unknown',
            computerName: 'Unknown',
            domain: 'LADPSS',
            browser: 'Unknown',
            timestamp: new Date().toLocaleString()
        };

        // Detect browser information
        function detectBrowser() {
            const userAgent = navigator.userAgent;
            let browserName = 'Unknown';
            let browserVersion = '';
            
            // Detect browser and version (order matters!)
            if (userAgent.indexOf("Firefox") > -1) {
                browserName = "Firefox";
                browserVersion = userAgent.match(/Firefox\/([0-9.]+)/)?.[1] || "";
            } else if (userAgent.indexOf("Opera") > -1 || userAgent.indexOf("OPR") > -1) {
                browserName = "Opera";
                browserVersion = userAgent.match(/(?:Opera|OPR)\/([0-9.]+)/)?.[1] || "";
            } else if (userAgent.indexOf("Edg") > -1) {
                browserName = "Edge";
                browserVersion = userAgent.match(/Edg\/([0-9.]+)/)?.[1] || "";
            } else if (userAgent.indexOf("Chrome") > -1 && userAgent.indexOf("Safari") > -1) {
                browserName = "Chrome";
                browserVersion = userAgent.match(/Chrome\/([0-9.]+)/)?.[1] || "";
            } else if (userAgent.indexOf("Safari") > -1) {
                browserName = "Safari";
                browserVersion = userAgent.match(/Version\/([0-9.]+)/)?.[1] || "";
            } else if (userAgent.indexOf("MSIE") > -1 || userAgent.indexOf("Trident/") > -1) {
                browserName = "Internet Explorer";
                browserVersion = userAgent.match(/(?:MSIE |rv:)([0-9.]+)/)?.[1] || "";
            }
            
            return browserVersion ? `${browserName} ${browserVersion}` : browserName;
        }

        // Get computer information from server
        async function getComputerInfo() {
            try {
                // Get system information from our API
                try {
                    const systemResponse = await fetch('/api/system-info').catch(() => null);
                    if (systemResponse && systemResponse.ok) {
                        const systemData = await systemResponse.json();
                        if (systemData.success) {
                            computerInfo.ipAddress = systemData.system_info.ip_address || 'localhost';
                            computerInfo.userAccount = systemData.system_info.user_account || 'Unknown';
                            computerInfo.computerName = systemData.system_info.computer_name || 'Unknown';
                            computerInfo.domain = systemData.system_info.domain || 'LADPSS';
                        }
                    } else {
                        // Fallback values if server call fails
                        computerInfo.userAccount = 'Unknown';
                        computerInfo.computerName = 'Unknown';
                        computerInfo.ipAddress = 'localhost';
                    }
                } catch (error) {
                    console.log('Could not get system info from server, using fallback');
                    computerInfo.userAccount = 'Unknown';
                    computerInfo.computerName = 'Unknown';
                    computerInfo.ipAddress = 'localhost';
                }
                
                // Get browser info (client-side detection)
                computerInfo.browser = detectBrowser();
                
                // Update timestamp
                computerInfo.timestamp = new Date().toLocaleString();
                
                // Update display
                updateComputerInfoDisplay();
            } catch (error) {
                console.error('Error getting computer info:', error);
            }
        }

        // Update computer information display
        function updateComputerInfoDisplay() {
            document.getElementById('ipAddress').textContent = computerInfo.ipAddress;
            document.getElementById('domain').textContent = computerInfo.domain;
            document.getElementById('browserInfo').textContent = computerInfo.browser;
            document.getElementById('timestamp').textContent = computerInfo.timestamp;
        }

        // Submit ticket to queue database
        async function submitToTicketQueue(formData, supportTeam, employeeNumber, employeeName, phoneNumber, location, section) {
            try {
                // Get recipient display name from selected option
                const recipientSelect = document.getElementById('emailRecipient');
                const selectedOption = recipientSelect.options[recipientSelect.selectedIndex];
                const recipientDisplayName = selectedOption.text;
                
                // Check if this is on behalf of another person
                const onBehalf = formData.get('onBehalf');
                const otherEmployeeNumber = formData.get('otherEmployeeNumber');
                const otherEmployeeName = formData.get('otherEmployeeName');
                
                // Prepare ticket data for database (matching API schema)
                const ticketData = {
                    user_name: employeeName,
                    employee_number: employeeNumber,
                    phone_number: phoneNumber,
                    location: location,
                    section: section,
                    teleworking: formData.get('teleworking'),
                    submitted_by: employeeName,
                    submitted_by_employee_number: employeeNumber,
                    on_behalf: onBehalf === 'Yes',
                    issue_title: formData.get('issueTitle'),
                    issue_description: formData.get('issueDescription'),
                    computer_info: computerInfo,
                    priority: 'medium',
                    email_recipient: supportTeam,
                    email_recipient_display: recipientDisplayName
                };
                
                console.log('Submitting ticket to queue:', ticketData);
                
                // Submit to server
                const response = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ticketData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`‚úÖ Ticket ${result.submission_id} submitted to support queue successfully!`, 'success');
                    console.log('Ticket submitted successfully:', result);
                } else {
                    throw new Error(result.error || 'Failed to submit ticket');
                }
                
            } catch (error) {
                console.error('Failed to submit ticket to queue:', error);
                showNotification('‚ö†Ô∏è Email generated, but failed to add to support queue. Please contact IT directly.', 'warning');
            }
        }

        // Generate email with form data
        async function generateEmail(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const supportTeam = formData.get('emailRecipient');
            const employeeNumber = formData.get('employeeNumber');
            const employeeName = formData.get('employeeName');
            const phoneNumber = formData.get('phoneNumber');
            const location = formData.get('location');
            const section = formData.get('section');
            
            // Save user information for future use
            if (supportTeam && employeeNumber && employeeName && phoneNumber && location && section) {
                saveUserInfo(supportTeam, employeeNumber, employeeName, phoneNumber, location, section);
            }
            
            // Submit to ticket queue database (new functionality)
            await submitToTicketQueue(formData, supportTeam, employeeNumber, employeeName, phoneNumber, location, section);
            
            const emailData = {
                recipient: supportTeam,
                teleworking: formData.get('teleworking'),
                phoneNumber: phoneNumber,
                location: location,
                section: section,
                issueTitle: formData.get('issueTitle'),
                issueDescription: formData.get('issueDescription'),
                employeeNumber: employeeNumber,
                employeeName: employeeName
            };

            // Check if this is on behalf of another person
            const onBehalf = formData.get('onBehalf');
            const otherEmployeeNumber = formData.get('otherEmployeeNumber');
            const otherEmployeeName = formData.get('otherEmployeeName');

            // Get recipient display name from selected option
            const recipientSelect = document.getElementById('emailRecipient');
            const selectedOption = recipientSelect.options[recipientSelect.selectedIndex];
            const recipientDisplayName = selectedOption.text;

            // Create email subject with issue title, name, and employee number
            let subject;
            if (onBehalf === 'Yes' && otherEmployeeNumber && otherEmployeeName) {
                subject = `IT Assistance Needed | ${emailData.issueTitle} | For: ${otherEmployeeName} | ${otherEmployeeNumber} | From: ${emailData.employeeName}`;
            } else {
                subject = `IT Assistance Needed | ${emailData.issueTitle} | ${emailData.employeeName} | ${emailData.employeeNumber}`;
            }
            
            // Get time-based greeting
            const currentHour = new Date().getHours();
            let greeting;
            if (currentHour < 12) {
                greeting = 'Good morning';
            } else if (currentHour < 17) {
                greeting = 'Good afternoon';
            } else {
                greeting = 'Good evening';
            }
            
            let issueForText = '';
            let contactInfoTable = '';
            
            if (onBehalf === 'Yes' && otherEmployeeNumber && otherEmployeeName) {
                issueForText = `I am submitting this request on behalf of ${otherEmployeeName} (${otherEmployeeNumber}).

`;
                contactInfoTable = `<h3 style="color: #047dba; margin-bottom: 10px;">CONTACT INFORMATION:</h3>
<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; max-width: 600px; font-family: Arial, sans-serif; font-size: 14px;">
    <tr style="background-color: #f8f9fa;">
        <td style="font-weight: bold; width: 40%; border: 1px solid #dee2e6;">Name:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.employeeName}</td>
    </tr>
    <tr>
        <td style="font-weight: bold; background-color: #f8f9fa; border: 1px solid #dee2e6;">Employee Number:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.employeeNumber}</td>
    </tr>
    <tr style="background-color: #f8f9fa;">
        <td style="font-weight: bold; border: 1px solid #dee2e6;">For (Other Employee):</td>
        <td style="border: 1px solid #dee2e6;">${otherEmployeeName}</td>
    </tr>
    <tr>
        <td style="font-weight: bold; background-color: #f8f9fa; border: 1px solid #dee2e6;">Other Employee Number:</td>
        <td style="border: 1px solid #dee2e6;">${otherEmployeeNumber}</td>
    </tr>
    <tr style="background-color: #f8f9fa;">
        <td style="font-weight: bold; border: 1px solid #dee2e6;">Teleworking:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.teleworking}</td>
    </tr>
    <tr>
        <td style="font-weight: bold; background-color: #f8f9fa; border: 1px solid #dee2e6;">Contact Phone:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.phoneNumber}</td>
    </tr>
    <tr style="background-color: #f8f9fa;">
        <td style="font-weight: bold; border: 1px solid #dee2e6;">Location:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.location}</td>
    </tr>
    <tr>
        <td style="font-weight: bold; background-color: #f8f9fa; border: 1px solid #dee2e6;">Section:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.section}</td>
    </tr>
</table>`;
            } else {
                contactInfoTable = `<h3 style="color: #047dba; margin-bottom: 10px;">CONTACT INFORMATION:</h3>
<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; max-width: 600px; font-family: Arial, sans-serif; font-size: 14px;">
    <tr style="background-color: #f8f9fa;">
        <td style="font-weight: bold; width: 40%; border: 1px solid #dee2e6;">Name:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.employeeName}</td>
    </tr>
    <tr>
        <td style="font-weight: bold; background-color: #f8f9fa; border: 1px solid #dee2e6;">Employee Number:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.employeeNumber}</td>
    </tr>
    <tr style="background-color: #f8f9fa;">
        <td style="font-weight: bold; border: 1px solid #dee2e6;">Teleworking:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.teleworking}</td>
    </tr>
    <tr>
        <td style="font-weight: bold; background-color: #f8f9fa; border: 1px solid #dee2e6;">Contact Phone:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.phoneNumber}</td>
    </tr>
    <tr style="background-color: #f8f9fa;">
        <td style="font-weight: bold; border: 1px solid #dee2e6;">Location:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.location}</td>
    </tr>
    <tr>
        <td style="font-weight: bold; background-color: #f8f9fa; border: 1px solid #dee2e6;">Section:</td>
        <td style="border: 1px solid #dee2e6;">${emailData.section}</td>
    </tr>
</table>`;
            }

            const computerInfoTable = `<h3 style="color: #047dba; margin-bottom: 10px;">COMPUTER INFORMATION:</h3>
<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; max-width: 600px; font-family: Arial, sans-serif; font-size: 14px;">
    <tr style="background-color: #f8f9fa;">
        <td style="font-weight: bold; width: 40%; border: 1px solid #dee2e6;">IP Address:</td>
        <td style="border: 1px solid #dee2e6;">${computerInfo.ipAddress}</td>
    </tr>
    <tr>
        <td style="font-weight: bold; background-color: #f8f9fa; border: 1px solid #dee2e6;">Domain:</td>
        <td style="border: 1px solid #dee2e6;">${computerInfo.domain}</td>
    </tr>
    <tr style="background-color: #f8f9fa;">
        <td style="font-weight: bold; border: 1px solid #dee2e6;">Browser:</td>
        <td style="border: 1px solid #dee2e6;">${computerInfo.browser}</td>
    </tr>
    <tr>
        <td style="font-weight: bold; background-color: #f8f9fa; border: 1px solid #dee2e6;">Timestamp:</td>
        <td style="border: 1px solid #dee2e6;">${computerInfo.timestamp}</td>
    </tr>
</table>`;

            // Create email body with time-based greeting and team name
            const body = `<html><body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
<p><strong>${greeting}, ${recipientDisplayName} Team,</strong></p>

<p>${issueForText}I need assistance with the following issue:</p>

<p style="background-color: #f8f9fa; padding: 15px; border-left: 4px solid #047dba; margin: 20px 0;">
<strong>${emailData.issueDescription}</strong>
</p>

${contactInfoTable}

<br>

${computerInfoTable}

<p>Thank you for your assistance.</p>
</body></html>`;

            // Automatically copy formatted HTML and open email client
            await copyFormattedEmailAndOpen(subject, body, emailData.recipient);
        }

        // Reset form to default values
        function resetForm() {
            document.getElementById('emailGeneratorForm').reset();
            showNotification('Form reset to default values.', 'info');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // Set colors based on type
            let backgroundColor;
            switch(type) {
                case 'success': backgroundColor = '#4caf50'; break;
                case 'warning': backgroundColor = '#ff9800'; break;
                case 'error': backgroundColor = '#f44336'; break;
                default: backgroundColor = '#2196f3'; break;
            }
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${backgroundColor};
                color: white;
                border-radius: 4px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                max-width: 400px;
                word-wrap: break-word;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Automatically copy formatted HTML and open email client
        async function copyFormattedEmailAndOpen(subject, htmlBody, recipient) {
            try {
                // Show loading notification
                showNotification('üìã Copying formatted email...', 'info');
                
                // Check for secure context and clipboard API availability
                if (!navigator.clipboard) {
                    throw new Error('Clipboard API not available - not a secure context');
                }
                
                // Copy HTML to clipboard with improved error handling
                if (navigator.clipboard.write && window.ClipboardItem) {
                    try {
                        // Use modern clipboard API for rich text
                        const htmlBlob = new Blob([htmlBody], { type: 'text/html' });
                        const textBlob = new Blob([stripHtmlForText(htmlBody)], { type: 'text/plain' });
                        
                        const clipboardItem = new ClipboardItem({
                            'text/html': htmlBlob,
                            'text/plain': textBlob
                        });
                        
                        await navigator.clipboard.write([clipboardItem]);
                    } catch (clipboardError) {
                        console.warn('Rich clipboard failed, trying text fallback:', clipboardError);
                        // Fallback to text-only clipboard
                        await navigator.clipboard.writeText(stripHtmlForText(htmlBody));
                    }
                } else if (navigator.clipboard.writeText) {
                    // Fallback to text clipboard only
                    await navigator.clipboard.writeText(stripHtmlForText(htmlBody));
                } else {
                    throw new Error('No clipboard API available');
                }
                
                // Show preview popup briefly, then auto-open email
                showQuickPreviewAndOpen(subject, htmlBody, recipient);
                
            } catch (error) {
                console.error('Failed to copy:', error);
                showNotification('üìã Manual Copy Required - Automatic copy failed. Please copy the HTML manually.', 'warning');
                showManualPreview(subject, htmlBody, recipient);
            }
        }

        // Helper function to convert HTML to bullet-point format (like commit 9495167)
        function stripHtmlForText(html) {
            let text = html;
            
            // Remove HTML document wrapper
            text = text.replace(/<html><body[^>]*>/, '').replace(/<\/body><\/html>/, '');
            
            // Remove style and script tags
            text = text.replace(/<style[^>]*>.*?<\/style>/gi, '');
            text = text.replace(/<script[^>]*>.*?<\/script>/gi, '');
            
            // Convert paragraphs to line breaks
            text = text.replace(/<p[^>]*>/gi, '\n').replace(/<\/p>/gi, '\n');
            text = text.replace(/<br\s*\/?>/gi, '\n');
            
            // Remove strong tags but keep content
            text = text.replace(/<\/?strong[^>]*>/gi, '');
            
            // Convert H3 headers to section headers
            text = text.replace(/<h3[^>]*>([^<]*)<\/h3>/gi, '\n$1');
            
            // Convert HTML tables to bullet points
            text = text.replace(/<table[^>]*>[\s\S]*?<\/table>/gi, (tableMatch) => {
                let bulletPoints = '';
                const rows = tableMatch.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi) || [];
                
                rows.forEach(row => {
                    const cells = row.match(/<td[^>]*>([^<]*)<\/td>/gi) || [];
                    if (cells.length >= 2) {
                        const label = cells[0].replace(/<[^>]*>/g, '').trim();
                        const value = cells[1].replace(/<[^>]*>/g, '').trim();
                        if (label && value) {
                            bulletPoints += `‚Ä¢ ${label} ${value}\n`;
                        }
                    }
                });
                
                return bulletPoints;
            });
            
            // Remove remaining HTML tags
            text = text.replace(/<[^>]+>/gi, '');
            
            // Clean up whitespace
            text = text.replace(/\n\s*\n\s*\n/g, '\n\n'); // Remove excessive line breaks
            text = text.replace(/^\s+|\s+$/g, ''); // Trim
            
            // Ensure proper spacing around sections
            text = text.replace(/CONTACT INFORMATION:/g, '\nCONTACT INFORMATION:');
            text = text.replace(/COMPUTER INFORMATION:/g, '\nCOMPUTER INFORMATION:');
            
            return text.trim();
        }

        // Show quick preview and automatically open email client
        function showQuickPreviewAndOpen(subject, htmlBody, recipient) {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
            `;

            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                border-radius: 12px;
                width: 90%;
                max-width: 800px;
                max-height: 80%;
                overflow: hidden;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                animation: modalFadeIn 0.3s ease-out;
            `;

            // Create content
            modal.innerHTML = `
                <div style="background: #047dba; color: white; padding: 20px; text-align: center;">
                    <h2 style="margin: 0; font-size: 24px;">üìß Email Ready!</h2>
                    <p style="margin: 10px 0 0 0; opacity: 0.9;">Formatted content copied to clipboard</p>
                </div>
                
                <div style="padding: 30px; text-align: center;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #047dba;">
                        <strong>To:</strong> ${recipient}<br>
                        <strong>Subject:</strong> ${subject}
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <div style="font-size: 20px; margin-bottom: 10px;">‚úÖ Formatted Email Copied!</div>
                        <p style="margin: 0; color: #666;">Your email client will open in <span id="countdown">3</span> seconds...</p>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="openNow" style="background: #047dba; color: white; border: none; padding: 15px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">üìß Open Email Now</button>
                        <button id="cancelOpen" style="background: #6c757d; color: white; border: none; padding: 15px 25px; border-radius: 6px; cursor: pointer; font-size: 16px;">Cancel</button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; font-size: 14px; color: #856404;">
                        <strong>‚úÖ Email will open with content!</strong><br>
                        <em>Optional:</em> For even better formatting, press <kbd style="background: #f8f9fa; padding: 2px 6px; border: 1px solid #ddd; border-radius: 3px;">Ctrl+V</kbd> to paste the HTML version over the plain text.
                    </div>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Add modal animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes modalFadeIn {
                    from { opacity: 0; transform: scale(0.9) translateY(-50px); }
                    to { opacity: 1; transform: scale(1) translateY(0); }
                }
            `;
            document.head.appendChild(style);

            // Countdown and auto-open functionality
            let countdown = 3;
            const countdownElement = document.getElementById('countdown');
            
            const timer = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    openEmailClient();
                }
            }, 1000);

            // Open email client function
            function openEmailClient() {
                // Create plain text version for mailto body
                const plainTextBody = stripHtmlForText(htmlBody);
                const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(plainTextBody)}`;
                window.location.href = mailtoLink;
                overlay.remove();
                showNotification('üìß Email opened with content! For better formatting, press Ctrl+V to paste the HTML version.', 'success');
            }

            // Event handlers
            document.getElementById('openNow').onclick = () => {
                clearInterval(timer);
                openEmailClient();
            };

            document.getElementById('cancelOpen').onclick = () => {
                clearInterval(timer);
                overlay.remove();
                showNotification('üìã Formatted content is still copied to clipboard.', 'info');
            };

            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    clearInterval(timer);
                    overlay.remove();
                }
            };

            // Escape key
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    clearInterval(timer);
                    overlay.remove();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        // Fallback manual preview (if automatic copy fails)
        function showManualPreview(subject, htmlBody, recipient) {
            // Simple manual copy interface (simplified version of original)
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.7); z-index: 10000;
                display: flex; justify-content: center; align-items: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white; border-radius: 8px; width: 90%; max-width: 600px;
                padding: 30px; text-align: center;
            `;

            modal.innerHTML = `
                <h2 style="color: #047dba; margin-bottom: 20px;">üìß Manual Copy Required</h2>
                <p>Automatic copy failed. Please copy the HTML manually:</p>
                <textarea readonly style="width: 100%; height: 200px; margin: 15px 0; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px;">${htmlBody}</textarea>
                <div>
                    <button onclick="navigator.clipboard.writeText(\`${htmlBody.replace(/`/g, '\\`')}\`).then(() => this.textContent='‚úÖ Copied!')" 
                            style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                        üìã Copy HTML
                    </button>
                    <button onclick="window.location.href='mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(stripHtmlForText(htmlBody))}'"
                            style="background: #047dba; color: white; border: none; padding: 10px 20px; border-radius: 4px; margin-right: 10px; cursor: pointer;">
                        üìß Open Email
                    </button>
                    <button onclick="this.closest('.overlay').remove()"
                            style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;

            overlay.className = 'overlay';
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); }
                to { transform: translateX(0); }
            }
            @keyframes slideOut {
                from { transform: translateX(0); }
                to { transform: translateX(100%); }
            }
        `;
        document.head.appendChild(style);

        // Auto-renewal preference management
        function getAutoRenewPreference() {
            const pref = localStorage.getItem('autoRenewStorage');
            return pref === 'true'; // Default to false if not set
        }
        
        function setAutoRenewPreference(enabled) {
            localStorage.setItem('autoRenewStorage', enabled.toString());
        }

        // Populate section dropdown with organizational data
        function populateSectionDropdown() {
            const sectionSelect = document.getElementById('section');
            
            // Clear existing options except the first one
            while (sectionSelect.options.length > 1) {
                sectionSelect.removeChild(sectionSelect.lastChild);
            }
            
            // Add all sections from organizational data
            organizationalData.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionSelect.appendChild(option);
            });
        }
        
        // User information localStorage management
        function loadUserInfo() {
            const stored = localStorage.getItem('userInfoData');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    const now = new Date().getTime();
                    
                    // Check if data is still valid (30 days)
                    if (now - data.timestamp < 30 * 24 * 60 * 60 * 1000) {
                        // Data is still valid, populate the fields (but keep them visible)
                        const fields = {
                            'emailRecipient': data.supportTeam,
                            'employeeNumber': data.employeeNumber,
                            'employeeName': data.employeeName,
                            'phoneNumber': data.phoneNumber,
                            'location': data.location,
                            'section': data.section
                        };
                        
                        for (const [fieldId, value] of Object.entries(fields)) {
                            const field = document.getElementById(fieldId);
                            if (field && value) {
                                field.value = value;
                            }
                        }
                        
                        // Auto-renew timestamp if enabled
                        if (getAutoRenewPreference()) {
                            data.timestamp = now;
                            localStorage.setItem('userInfoData', JSON.stringify(data));
                        }
                        
                        return data;
                    } else {
                        // Data expired, remove it
                        localStorage.removeItem('userInfoData');
                    }
                } catch (e) {
                    // Invalid data, remove it
                    localStorage.removeItem('userInfoData');
                }
            }
            return null;
        }
        
        function saveUserInfo(supportTeam, employeeNumber, employeeName, phoneNumber, location, section) {
            const data = {
                supportTeam: supportTeam,
                employeeNumber: employeeNumber,
                employeeName: employeeName,
                phoneNumber: phoneNumber,
                location: location,
                section: section,
                timestamp: new Date().getTime()
            };
            localStorage.setItem('userInfoData', JSON.stringify(data));
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Populate section dropdown with current organizational data
            populateSectionDropdown();
            
            // Set up "on behalf" radio button functionality
            const onBehalfRadios = document.querySelectorAll('input[name="onBehalf"]');
            const otherEmployeeGroup = document.getElementById('otherEmployeeGroup');
            const otherEmployeeNumber = document.getElementById('otherEmployeeNumber');
            const otherEmployeeName = document.getElementById('otherEmployeeName');
            
            onBehalfRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Get labels that need to change
                    const nameLabel = document.querySelector('label[for="employeeName"]');
                    const teleworkingLabel = document.querySelector('input[name="teleworking"]').closest('.form-group').querySelector('label');
                    const phoneLabel = document.querySelector('label[for="phoneNumber"]');
                    const locationLabel = document.querySelector('label[for="location"]');
                    
                    if (this.value === 'Yes') {
                        // Show other employee fields
                        otherEmployeeGroup.style.display = 'block';
                        otherEmployeeNumber.required = true;
                        otherEmployeeName.required = true;
                        
                        // Change labels to reflect form is for someone else
                        if (nameLabel) nameLabel.textContent = 'Your Name:';
                        if (teleworkingLabel) teleworkingLabel.textContent = 'Are they teleworking today?';
                        if (phoneLabel) phoneLabel.textContent = 'Their Contact number:';
                        if (locationLabel) locationLabel.textContent = 'Their Cubicle/Office#:';
                    } else {
                        // Hide other employee fields
                        otherEmployeeGroup.style.display = 'none';
                        otherEmployeeNumber.required = false;
                        otherEmployeeName.required = false;
                        otherEmployeeNumber.value = '';
                        otherEmployeeName.value = '';
                        
                        // Change labels back to original text
                        if (nameLabel) nameLabel.textContent = 'Name:';
                        if (teleworkingLabel) teleworkingLabel.textContent = 'Are you teleworking today?';
                        if (phoneLabel) phoneLabel.textContent = 'Phone:';
                        if (locationLabel) locationLabel.textContent = 'Cubicle / Room #:';
                    }
                });
            });

            // Set up auto-renewal toggle
            const autoRenewCheckbox = document.getElementById('autoRenewStorage');
            autoRenewCheckbox.checked = getAutoRenewPreference();
            
            // Add event listener for auto-renewal toggle
            autoRenewCheckbox.addEventListener('change', function() {
                setAutoRenewPreference(this.checked);
            });
            
            // Set up phone number formatting
            const phoneInput = document.getElementById('phoneNumber');
            phoneInput.addEventListener('input', function(e) {
                // Remove all non-digits
                let value = e.target.value.replace(/\D/g, '');
                
                // Limit to 10 digits as requested
                if (value.length > 10) {
                    value = value.slice(0, 10);
                }
                
                // Format as (XXX) XXX-XXXX for 10 digits
                if (value.length >= 6) {
                    e.target.value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
                } else if (value.length >= 3) {
                    e.target.value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
                } else if (value.length > 0) {
                    e.target.value = `(${value}`;
                } else {
                    e.target.value = '';
                }
            });

            // Set up employee number formatting (first char e/c/t, then 6 digits)
            function setupEmployeeNumberFormatting(inputElement) {
                inputElement.addEventListener('input', function(e) {
                    let value = e.target.value.toLowerCase();
                    
                    // Limit to 7 characters max
                    if (value.length > 7) {
                        value = value.slice(0, 7);
                    }
                    
                    // Format: first character must be e, c, or t; rest must be digits
                    if (value.length > 0) {
                        // Ensure first character is e, c, or t
                        const firstChar = value.charAt(0);
                        if (firstChar !== 'e' && firstChar !== 'c' && firstChar !== 't') {
                            // If invalid first character, clear or keep previous valid state
                            if (e.target.value.length <= 1) {
                                e.target.value = '';
                                return;
                            } else {
                                value = e.target.value.slice(0, -1);
                            }
                        }
                        
                        // Ensure characters 2-7 are digits only
                        if (value.length > 1) {
                            const numberPart = value.slice(1).replace(/\D/g, '');
                            value = value.charAt(0) + numberPart;
                            
                            // Limit to 6 digits after the letter
                            if (numberPart.length > 6) {
                                value = value.charAt(0) + numberPart.slice(0, 6);
                            }
                        }
                    }
                    
                    e.target.value = value;
                });
            }
            
            const employeeNumberInput = document.getElementById('employeeNumber');
            const otherEmployeeNumberInput = document.getElementById('otherEmployeeNumber');
            setupEmployeeNumberFormatting(employeeNumberInput);
            setupEmployeeNumberFormatting(otherEmployeeNumberInput);

            // Load saved user information
            const savedUserInfo = loadUserInfo();
            
            // Get computer information
            getComputerInfo();
            
            // Update timestamp every minute
            setInterval(() => {
                computerInfo.timestamp = new Date().toLocaleString();
                document.getElementById('timestamp').textContent = computerInfo.timestamp;
            }, 60000);
            
            // Attach form submit handler
            document.getElementById('emailGeneratorForm').addEventListener('submit', generateEmail);
            
            // Add keyboard shortcut for ticket management system (Ctrl+T)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 't') {
                    e.preventDefault();
                    showLoginModal();
                }
            });
        });

        // Phone number formatting
        document.getElementById('phoneNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            let formattedValue = '';
            
            if (value.length > 0) {
                if (value.length <= 3) {
                    formattedValue = `(${value}`;
                } else if (value.length <= 6) {
                    formattedValue = `(${value.slice(0, 3)}) ${value.slice(3)}`;
                } else {
                    formattedValue = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
                }
            }
            
            e.target.value = formattedValue;
        });

        // ==========================================
        // LOGIN MODAL FUNCTIONALITY
        // ==========================================

        // Show login modal
        function showLoginModal() {
            const loginModal = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 login-overlay" id="loginOverlay">
                    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md mx-4 login-modal">
                        <h2 class="text-xl font-bold text-center text-blue-600 mb-6">üîê IT Team Access</h2>
                        <form id="loginForm" class="space-y-4">
                            <input type="text" id="username" placeholder="Username" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <input type="password" id="password" placeholder="Password" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <button type="submit" 
                                    class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                Login
                            </button>
                            <button type="button" onclick="closeLoginModal()" 
                                    class="w-full px-4 py-2 bg-gray-600 text-white font-medium rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                                Cancel
                            </button>
                        </form>
                        <div id="loginError" class="text-red-600 text-sm text-center mt-4 hidden"></div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loginModal);
            
            // Focus on username field
            setTimeout(() => {
                document.getElementById('username').focus();
            }, 100);
            
            // Handle form submission
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Handle escape key
            document.addEventListener('keydown', handleEscapeKey);
        }

        // Close login modal
        function closeLoginModal() {
            const overlay = document.getElementById('loginOverlay');
            if (overlay) {
                overlay.remove();
            }
            document.removeEventListener('keydown', handleEscapeKey);
        }

        // Handle escape key
        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                closeLoginModal();
            }
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // Show loading state
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Logging in...';
            submitButton.disabled = true;
            errorDiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Store authentication token
                    localStorage.setItem('authToken', result.token);
                    localStorage.setItem('currentUser', JSON.stringify(result.user));
                    
                    console.log('Login successful, stored tokens');
                    
                    // Show success message
                    showNotification(`‚úÖ Welcome ${result.user.display_name}! Opening queue interface...`, 'success');
                    
                    // Close modal
                    closeLoginModal();
                    
                    console.log('About to redirect to tickets page...');
                    
                    // Redirect to queue interface after short delay
                    setTimeout(() => {
                        console.log('Redirecting now to /tickets');
                        // Pass auth data via URL to handle cross-origin localStorage issue
                        const authData = btoa(JSON.stringify({
                            token: result.token,
                            user: result.user
                        }));
                        window.location.href = `/tickets?auth=${authData}`;
                    }, 1500);
                    
                } else {
                    // Show error message
                    errorDiv.textContent = result.message || 'Invalid username or password';
                    errorDiv.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Connection error. Please ensure the server is running.';
                errorDiv.classList.remove('hidden');
            } finally {
                // Reset button state
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }

        // Make functions globally available
        window.showLoginModal = showLoginModal;
        window.closeLoginModal = closeLoginModal;
    </script>
</body>
</html>